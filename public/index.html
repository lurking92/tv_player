<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TV Subtitle (本機：情境 + 攝影機) - 除錯版</title>
  <style>
    :root { color-scheme: dark; }
    body { background:#0f1115; color:#eaeaea; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; margin:16px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    select, button, label { background:#1d2027; color:#eaeaea; border:none; border-radius:8px; padding:8px 12px; }
    button { cursor:pointer; }
    .screen { position:relative; width:100%; max-width:960px; aspect-ratio:16/9; border:1px solid #2a2f3a; border-radius:10px; background:#000; }
    .screen video { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }
    .caption { position:absolute; left:0; right:0; bottom:10px; text-align:center; }
    .caption span { background:rgba(0,0,0,.55); padding:6px 10px; border-radius:6px; }
    #diag { margin-left:8px; opacity:.8; font-size:12px; }
    #meta { opacity:.8; font-size:12px; }
    
    /* 除錯面板樣式 */
    .debug-panel { 
      background:#1a1e24; 
      border:1px solid #2a2f3a; 
      border-radius:8px; 
      padding:12px; 
      margin:16px 0; 
      font-family:monospace; 
      font-size:12px; 
      max-height:200px; 
      overflow-y:auto; 
    }
    .debug-title { color:#4a9eff; font-weight:bold; margin-bottom:8px; }
    .debug-item { margin:4px 0; }
    .debug-success { color:#4ade80; }
    .debug-error { color:#ef4444; }
    .debug-warning { color:#f59e0b; }
    .debug-info { color:#8b5cf6; }
    
    /* 手動進度條樣式 */
    .progress-container { 
      margin:8px 0; 
      display:flex; 
      align-items:center; 
      gap:8px; 
    }
    .progress-bar { 
      flex:1; 
      height:6px; 
      background:#2a2f3a; 
      border-radius:3px; 
      cursor:pointer; 
      position:relative; 
    }
    .progress-filled { 
      height:100%; 
      background:#4a9eff; 
      border-radius:3px; 
      width:0%; 
      transition:width 0.1s; 
    }
    .time-display { 
      font-size:11px; 
      color:#888; 
      min-width:80px; 
    }
  </style>
</head>
<body>
  <h1>TV Subtitle (本機：情境 sceneX_DayY + 攝影機 1~5) - 除錯版</h1>

  <div class="row">
    <label>情境：</label>
    <select id="sceneSelect"></select>

    <label>攝影機：</label>
    <select id="angleSelect">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <label style="margin-left:8px;">
      <input type="checkbox" id="autoPlayToggle" checked />
      自動按順序播放
    </label>
    <label style="margin-left:8px;">
      <input type="checkbox" id="aiToggle" />
      AI分析 (即時偵測)
    </label>
    <button id="testAI" style="background:#4a9eff;">測試 AI API</button>
    <span id="diag"></span>
  </div>

  <!-- 除錯面板 -->
  <div class="debug-panel">
    <div class="debug-title">API 除錯資訊</div>
    <div id="debugLog">等待 API 測試...</div>
  </div>

  <div class="screen">
    <div id="alertOverlay" style="position:absolute; top:10px; right:10px; padding:6px 10px; background:rgba(200,0,0,.85); color:#fff; border-radius:6px; display:none; z-index:5; font-weight:600;">警告</div>
    <canvas id="framegrab" width="0" height="0" style="display:none"></canvas>
    <video id="player" controls playsinline></video>
    <div class="caption"><span id="captionText">(敘述暫無)</span></div>
  </div>

  <!-- 手動進度條 -->
  <div class="progress-container">
    <div class="time-display" id="currentTime">0:00</div>
    <div class="progress-bar" id="progressBar">
      <div class="progress-filled" id="progressFilled"></div>
    </div>
    <div class="time-display" id="duration">0:00</div>
  </div>

  <div class="row" style="margin-top:10px;">
    <label>活動：</label>
    <select id="videoSelect" style="min-width:360px;"></select>
    <button id="btnPlay">播放</button>
    <button id="btnPause">暫停</button>
    <button id="btnPrev">上一個</button>
    <button id="btnNext">下一個</button>
    <button id="btnReset">重置</button>
    <div id="meta"></div>
  </div>

  <div>字幕清單 (敘述先空白)：</div>
  <ul id="list"></ul>

<script>
  const MANIFEST_URL = "./manifest.json";

  const sceneSel = document.getElementById('sceneSelect');
  const angleSel = document.getElementById('angleSelect');
  const vsel   = document.getElementById('videoSelect');
  const player = document.getElementById('player');
  const caption= document.getElementById('captionText');
  const list   = document.getElementById('list');
  const meta   = document.getElementById('meta');
  const diag   = document.getElementById('diag');
  const debugLog = document.getElementById('debugLog');

  let manifest = null;
  let playlist = [];
  let intervalSec = 2.5;

  // 除錯記錄函數
  function addDebugLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
      success: 'debug-success',
      error: 'debug-error', 
      warning: 'debug-warning',
      info: 'debug-info'
    };
    const className = colors[type] || 'debug-info';
    debugLog.innerHTML += `<div class="debug-item"><span class="${className}">[${timestamp}] ${message}</span></div>`;
    debugLog.scrollTop = debugLog.scrollHeight;
  }

  // 測試 API 按鈕
  document.getElementById('testAI').onclick = async () => {
    addDebugLog('開始測試 AI API 連線...', 'info');
    
    // 創建一個簡單的測試圖像 - 模擬一個人在跑步的場景
    const testCanvas = document.createElement('canvas');
    testCanvas.width = 320;
    testCanvas.height = 240;
    const ctx = testCanvas.getContext('2d');
    
    // 繪製一個更明顯的測試場景
    ctx.fillStyle = '#87CEEB'; // 天空藍
    ctx.fillRect(0, 0, 320, 240);
    
    ctx.fillStyle = '#32CD32'; // 草地綠
    ctx.fillRect(0, 180, 320, 60);
    
    // 畫一個人形 (簡化版)
    ctx.fillStyle = '#FFB366'; // 膚色
    ctx.fillRect(150, 100, 20, 30); // 頭
    ctx.fillRect(145, 130, 30, 40); // 身體
    ctx.fillRect(140, 170, 15, 30); // 左腿 (跑步姿勢)
    ctx.fillRect(165, 160, 15, 40); // 右腿
    
    const testDataUrl = testCanvas.toDataURL('image/jpeg', 0.8);
    
    try {
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dataUrl: testDataUrl })
      });
      
      addDebugLog(`API 回應狀態: ${res.status} ${res.statusText}`, res.ok ? 'success' : 'error');
      
      if (!res.ok) {
        const errorText = await res.text();
        addDebugLog(`錯誤內容: ${errorText}`, 'error');
        return;
      }
      
      const result = await res.json();
      addDebugLog(`API 回應成功: ${JSON.stringify(result)}`, 'success');
      
      if (result.raw) {
        addDebugLog(`AI 原始回應: ${result.raw}`, 'info');
      }
      
      if (result.error) {
        addDebugLog(`API 內部錯誤: ${result.error}`, 'error');
      } else if (result.result) {
        addDebugLog(`解析結果: ${JSON.stringify(result.result)}`, 'success');
        // 測試更新UI
        updateAIUI(result);
      }
      
    } catch (e) {
      addDebugLog(`網路錯誤: ${e.message}`, 'error');
    }
  };

  const autoPlayToggle = () => document.getElementById('autoPlayToggle')?.checked;

  document.getElementById('btnPlay').onclick  = () => player.play();
  document.getElementById('btnPause').onclick = () => player.pause();
  document.getElementById('btnPrev').onclick  = () => { 
    const i = vsel.selectedIndex; 
    if (i > 0) { 
      vsel.selectedIndex = i - 1; 
      loadVideoByIndex(i - 1); 
      player.play(); 
    } 
  };
  document.getElementById('btnNext').onclick  = () => { 
    const i = vsel.selectedIndex; 
    if (i + 1 < playlist.length) { 
      vsel.selectedIndex = i + 1; 
      loadVideoByIndex(i + 1); 
      player.play(); 
    } 
  };
  document.getElementById('btnReset').onclick = () => { player.currentTime = 0; };

  vsel.onchange = () => loadVideoByIndex(vsel.selectedIndex);
  // 只在攝影機改變時觸發，場景改變時重置到第一個活動
  sceneSel.onchange = () => {
    // 場景改變，重置到第一個活動
    buildPlaylistFromManifest();
  };
  angleSel.onchange = () => {
    // 攝影機改變，保持當前活動
    buildPlaylistFromManifest();
  };

  player.addEventListener('error', () => {
    const err = player.error;
    console.error('Video element error:', err, 'src=', player.currentSrc || player.src);
    meta.textContent = `影片載入失敗：${player.currentSrc || player.src}`;
  });

  // 手動進度條功能
  const progressBar = document.getElementById('progressBar');
  const progressFilled = document.getElementById('progressFilled');
  const currentTimeDisplay = document.getElementById('currentTime');
  const durationDisplay = document.getElementById('duration');

  function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function updateProgress() {
    if (player.duration) {
      const progress = (player.currentTime / player.duration) * 100;
      progressFilled.style.width = progress + '%';
      currentTimeDisplay.textContent = formatTime(player.currentTime);
      durationDisplay.textContent = formatTime(player.duration);
    }
  }

  progressBar.addEventListener('click', (e) => {
    if (player.duration) {
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const progress = clickX / rect.width;
      const newTime = progress * player.duration;
      player.currentTime = newTime;
      addDebugLog(`手動跳轉至 ${formatTime(newTime)}`, 'info');
    }
  });

  player.addEventListener('timeupdate', updateProgress);
  player.addEventListener('loadedmetadata', updateProgress);

  async function loadManifest() {
    addDebugLog('開始載入 manifest.json...', 'info');
    const res = await fetch(MANIFEST_URL, { cache: "no-store" });
    if (!res.ok) {
      throw new Error(`HTTP ${res.status} ${res.statusText} @ ${res.url}`);
    }
    const text = await res.text();
    try {
      manifest = JSON.parse(text);
      addDebugLog('manifest.json 載入成功', 'success');
    } catch (err) {
      console.error("manifest.json 不是合法 JSON，前 500 字如下：\n", text.slice(0, 500));
      addDebugLog(`manifest.json 解析失敗: ${err.message}`, 'error');
      throw new Error("manifest.json 解析失敗 (JSON 格式錯誤)");
    }
    intervalSec = manifest?.config?.defaultIntervalSec ?? 2.5;
    initSceneDropdown();
  }

  function initSceneDropdown() {
    sceneSel.innerHTML = '';
    const scenes = manifest.scenes || [];
    scenes.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.title || s.id;
      sceneSel.appendChild(opt);
    });
    if (sceneSel.options.length > 0) {
      sceneSel.selectedIndex = 0;
      buildPlaylistFromManifest();
    }
  }

  function buildPlaylistFromManifest() {
    const sceneId = sceneSel.value;
    const angle   = String(angleSel.value);
    const scene   = (manifest.scenes || []).find(s => s.id === sceneId);
    
    // 記住當前播放的活動索引
    const currentActivityIndex = vsel.selectedIndex >= 0 ? vsel.selectedIndex : 0;
    
    playlist = [];

    if (!scene) {
      vsel.innerHTML = '';
      player.removeAttribute('src');
      player.load();
      meta.textContent = '找不到情境';
      list.innerHTML = '';
      caption.textContent = '(敘述暫無)';
      if (diag) diag.textContent = '';
      return;
    }

    const suffixMap = manifest.angleSuffixMap || { "1":"_0","2":"_1","3":"_2","4":"_3","5":"_4" };

    (scene.activities || []).forEach(act => {
      if (!act || !act.base || !act.ext) { 
        return; 
      }
      const suffix = suffixMap[angle] || "_0";
      const src = `${act.base}${suffix}${act.ext}`;
      playlist.push({ title: `${act.name} (camera ${angle})`, src });
    });

    vsel.innerHTML = '';
    playlist.forEach((v, i) => {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = v.title;
      vsel.appendChild(opt);
    });

    if (playlist.length) {
      // 保持在同一個活動，但不超過新列表的範圍
      const targetIndex = Math.min(currentActivityIndex, playlist.length - 1);
      vsel.value = String(targetIndex);
      loadVideoByIndex(targetIndex);
      meta.textContent = `可播數量=${playlist.length}`;
      addDebugLog(`載入場景 ${sceneId}，攝影機 ${angle}，共 ${playlist.length} 個影片，保持在活動 ${targetIndex + 1}`, 'success');
    } else {
      player.removeAttribute('src');
      player.load();
      meta.textContent = '此情境在此攝影機角度無可播影片';
      addDebugLog(`場景 ${sceneId} 在攝影機 ${angle} 無可用影片`, 'warning');
    }

    if (diag) {
      const totalActs = (scene.activities || []).length;
      const ok = playlist.length;
      const miss = totalActs - ok;
      diag.textContent = `活動總數=${totalActs}，可播=${ok}，缺檔=${miss}`;
    }

    list.innerHTML = '';
    caption.textContent = '(敘述暫無)';
  }

  function loadVideoByIndex(i) {
    const v = playlist[i];
    if (!v) return;
    player.src = v.src;
    player.currentTime = 0;
    meta.textContent = (playlist[i] && playlist[i].title) ? playlist[i].title : '';
    caption.textContent = '(敘述暫無)';
    addDebugLog(`載入影片: ${v.title}`, 'info');
    if (autoPlayToggle && typeof autoPlayToggle === 'function' && autoPlayToggle()) {
      try { player.play(); } catch (e) {}
    }
  }

  player.addEventListener('ended', () => {
    const i = vsel.selectedIndex;
    const next = i + 1;
    if (autoPlayToggle() && next < playlist.length) {
      vsel.selectedIndex = next;
      loadVideoByIndex(next);
      try { player.play(); } catch (e) { /* ignore */ }
    }
  });

  (async function init() {
    try {
      await loadManifest();
    } catch (e) {
      console.error(e);
      addDebugLog(`載入失敗: ${e.message}`, 'error');
      alert(`載入 manifest.json 失敗：${e.message}\n請先執行：node build_manifest.js`);
    }
  })();

  // AI 影像即時分析 (OpenRouter)
  const aiToggle = document.getElementById('aiToggle');
  const frameCanvas = document.getElementById('framegrab');
  const alertOverlay = document.getElementById('alertOverlay');
  const frameCtx = frameCanvas.getContext ? frameCanvas.getContext('2d') : null;
  let aiTimer = null;
  let aiBusy = false;

  function startAIAnalysis() {
    if (!aiToggle || !aiToggle.checked) return;
    if (aiTimer) return;
    addDebugLog('啟動 AI 即時分析', 'info');
    aiTimer = setInterval(captureAndAnalyze, 1500); // 1.5秒
  }

  function stopAIAnalysis() {
    if (aiTimer) { 
      clearInterval(aiTimer); 
      aiTimer = null; 
      addDebugLog('停止 AI 即時分析', 'info');
    }
  }

  async function captureAndAnalyze() {
    if (!aiToggle || !aiToggle.checked) return;
    if (aiBusy) return;
    if (!frameCtx) return;
    
    const vw = player.videoWidth || 0;
    const vh = player.videoHeight || 0;
    if (vw === 0 || vh === 0) return;
    if (player.paused || player.ended) return; // 只在播放時分析

    // 控制尺寸避免 payload 過大
    const MAX_W = 640; // 增加解析度以提高識別準確性
    const scale = Math.min(1, MAX_W / vw);
    frameCanvas.width = Math.round(vw * scale);
    frameCanvas.height = Math.round(vh * scale);
    frameCtx.drawImage(player, 0, 0, frameCanvas.width, frameCanvas.height);

    const dataUrl = frameCanvas.toDataURL('image/jpeg', 0.8); // 提高圖片品質

    aiBusy = true;
    try {
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dataUrl })
      });
      
      if (!res.ok) {
        const errorText = await res.text();
        addDebugLog(`AI API 錯誤 ${res.status}: ${errorText}`, 'error');
        return;
      }
      
      const out = await res.json();
      
      // 詳細記錄每次分析結果
      if (out.result) {
        const behaviors = [];
        if (out.result.fall) behaviors.push('跌倒');
        if (out.result.climbing) behaviors.push('爬高');
        if (out.result.running) behaviors.push('奔跑');
        if (out.result.disoriented) behaviors.push('迷失方向');
        
        if (behaviors.length > 0) {
          addDebugLog(`偵測到行為: ${behaviors.join(', ')}`, 'warning');
        } else {
          addDebugLog('未偵測到異常行為', 'info');
        }
      }
      
      if (out.raw) {
        addDebugLog(`AI 原始回應: ${out.raw.substring(0, 100)}...`, 'info');
      }
      
      updateAIUI(out);
      
      // 如果影片已結束且在等待 AI 回應，現在可以跳轉了
      if (videoEndedWaiting && endedVideoIndex >= 0) {
        addDebugLog('AI 分析完成，現在跳轉到下一個影片', 'info');
        proceedToNextVideo();
      }
      
    } catch (e) {
      addDebugLog(`AI 分析失敗: ${e.message}`, 'error');
    } finally {
      aiBusy = false;
    }
  }

  function updateAIUI(out) {
    try {
      const result = out && (out.result || out);
      if (!result) return;
      
      const stats = [
        ['跌倒', result.fall],
        ['爬高', result.climbing],
        ['奔跑', result.running],
        ['迷失方向', result.disoriented]
      ].map(([k, v]) => `${k}:${v ? '是' : '否'}`);
      
      if (diag) diag.textContent = stats.join('  ');

      const danger = result.fall || result.climbing || result.disoriented;
      if (danger) {
        alertOverlay.style.display = 'block';
        const dangerTypes = [];
        if (result.fall) dangerTypes.push('跌倒');
        if (result.climbing) dangerTypes.push('爬高');
        if (result.disoriented) dangerTypes.push('迷失方向');
        alertOverlay.textContent = `警告: ${dangerTypes.join(', ')}`;
      } else {
        alertOverlay.style.display = 'none';
      }
    } catch (e) {
      console.warn('updateAIUI error', e);
      addDebugLog(`UI 更新錯誤: ${e.message}`, 'error');
    }
  }

  if (aiToggle) {
    aiToggle.addEventListener('change', () => {
      if (aiToggle.checked && !player.paused) {
        startAIAnalysis();
      } else {
        stopAIAnalysis();
      }
    });
  }
  
  player.addEventListener('play', startAIAnalysis);
  player.addEventListener('pause', stopAIAnalysis);
  player.addEventListener('ended', stopAIAnalysis);

  // 初始化時添加歡迎訊息
  addDebugLog('TV Subtitle 除錯系統啟動', 'success');

</script>
</body>
</html>